/*********************************************************************************
**********************************************************************************
* 文件名称: fft.c
* 文件简述：DSP
* 创建日期：2024.07.1
* 修改日期：2025.07.22
* 说    明：FFT函数，幅度谱
* 优化思路借鉴MATLAB的局部峰值检测和阈值筛选，
* 提升了峰值查找的效率和准确性。
**********************************************************************************
*********************************************************************************/

/*float32_t win_Kaiser_beta15[FFT_N] = {2.94421270467906e-06,3.62754983485135e-06,4.38577013985947e-06,5.22402598772236e-06,6.14771132642611e-06,
7.16246935309510e-06,8.27420032536606e-06,9.48906951511384e-06,1.08135153046081e-05,1.22542574251076e-05,1.38183053378257e-05,1.55129667571281e-05,
1.73458563157455e-05,1.93249043717067e-05,2.14583659566217e-05,2.37548298648596e-05,2.62232278830887e-05,2.88728441595609e-05,3.17133247124374e-05,
3.47546870763700e-05,3.80073300864637e-05,4.14820437986555e-05,4.51900195454606e-05,4.91428601259405e-05,5.33525901286603e-05,5.78316663863055e-05,
6.25929885605379e-05,6.76499098555720e-05,7.30162478588579e-05,7.87062955071623e-05,8.47348321762326e-05,9.11171348921403e-05,9.78689896622899e-05,
0.000105006702923987,0.000112547113108345,0.000120507602317226,0.000128906108110785,0.000137761135403096,0.000147091768463240,0.000156917683019102,
0.000167259158461053,0.000178137090142558,0.000189573001774655,0.000201589057911143,0.000214208076521206,0.000227453541646089,0.000241349616136339,
0.000255921154466007,0.000271193715620105,0.000287193576051495,0.000303947742703283,0.000321483966092682,0.000339830753452181,0.000359017381923781,
0.000379073911801912,0.000400031199820560,0.000421920912480016,0.000444775539408549,0.000468628406754190,0.000493513690601726,0.000519466430409878,
0.000546522542463513,0.000574718833335692,0.000604093013354175,0.000634683710066956,0.000666530481701268,0.000699673830610405,0.000734155216702593,
0.000770017070846069,0.000807302808244372,0.000846056841775827,0.000886324595291020,0.000928152516862039,0.000971588091977111,0.00101667985667417,
0.00106347741060687,0.00111203143003635,0.00116239368074205,0.00121461703084474,0.00126875546353501,0.00132486408969991,0.00138299916044111,
0.00144321807947699,0.00150557941542184,0.00157014291393452,0.00163696950972940,0.00170612133844214,0.00177766174834261,0.00185165531188757,
0.00192816783710533,0.00200726637880464,0.00208901924960018,0.00217349603074663,0.00226076758277353,0.00235090605591301,0.00244398490031225,
0.00254007887602278,0.00263926406275841,0.00274161786941374,0.00284721904333506,0.00295614767933534,0.00306848522844527,0.00318431450639183,
0.00330371970179628,0.00342678638408327,0.00355360151109250,0.00368425343638493,0.00381883191623476,0.00395742811629930,0.00410013461795780,
0.00424704542431135,0.00439825596583520,0.00455386310567510,0.00471396514457954,0.00487866182545930,0.00504805433756603,0.00522224532028167,
0.00540133886651029,0.00558544052566415,0.00577465730623569,0.00596909767794747,0.00616887157347153,0.00637409038971055,0.00658486698863229,
0.00680131569764976,0.00702355230953866,0.00725169408188482,0.00748585973605332,0.00772616945567175,0.00797274488462004,0.00822570912451905,
0.00848518673171074,0.00875130371372193,0.00902418752520525,0.00930396706334889,0.00959077266274925,0.00988473608973834,0.0101859905361599,
0.0104946706125871,0.0108109123409746,0.0111348531467398,0.0114666318502657,0.0118063886578186,0.0121542651518766,0.0125104042808607,
0.0128749503482636,0.0132480490011709,0.0136298472181675,0.0140204932966261,0.0144201368393710,0.0148289287407116,0.0152470211718430,
0.0156745675656065,0.0161117226006068,0.0165586421846812,0.0170154834377170,0.0174824046738122,0.0179595653827761,0.0184471262109674,
0.0189452489414643,0.0194540964735653,0.0199738328016159,0.0205046229931609,0.0210466331664170,0.0216000304670658,0.0221649830443630,
0.0227416600265644,0.0233302314956640,0.0239308684614461,0.0245437428348475,0.0251690274006307,0.0258068957893668,0.0264575224487275,
0.0271210826140864,0.0277977522784294,0.0284877081615754,0.0291911276787067,0.0299081889082109,0.0306390705588351,0.0313839519361538,
0.0321430129083531,0.0329164338713316,0.0337043957131211,0.0345070797776307,0.0353246678277150,0.0361573420075710,0.0370052848044674,
0.0378686790098079,0.0387477076795357,0.0396425540938801,0.0405534017164524,0.0414804341526948,0.0424238351076866,0.0433837883433165,
0.0443604776348212,0.0453540867267027,0.0463647992880254,0.0473927988671032,0.0484382688455806,0.0495013923919190,0.0505823524142905,
0.0516813315128928,0.0527985119316884,0.0539340755095800,0.0550882036310289,0.0562610771761265,0.0574528764701284,0.0586637812324594,
0.0598939705252005,0.0611436227010695,0.0624129153509019,0.0637020252506474,0.0650111283078902,0.0663403995079058,0.0676900128592654,
0.0690601413390015,0.0704509568373443,0.0718626301020442,0.0732953306822925,0.0747492268722524,0.0762244856542149,0.0777212726413935,
0.0792397520203719,0.0807800864932165,0.0823424372192725,0.0839269637566551,0.0855338240034521,0.0871631741386537,0.0888151685628239,
0.0904899598385314,0.0921876986305533,0.0939085336458712,0.0956526115734742,0.0974200770239845,0.0992110724691285,0.101025738181062,
0.102864212171574,0.104726630131186,0.106613125368160,0.108523828747440,0.110458868629539,0.112418370809397,0.114402458455224,
0.116411252047342,0.118444869317065,0.120503425185606,0.122587031703061,0.124695797987470,0.126829830163977,0.128989231304121,
0.131174101365265,0.133384537130188,0.135620632146861,0.137882476668430,0.140170157593422,0.142483758406191,0.144823359117643,
0.147189036206239,0.149580862559307,0.151998907414690,0.154443236302739,0.156913910988681,0.159410989415382,0.161934525646523,
0.164484569810215,0.167061168043071,0.169664362434756,0.172294190973047,0.174950687489406,0.177633881605099,0.180343798677895,
0.183080459749330,0.185843881492603,0.188634076161092,0.191451051537521,0.194294810883808,0.197165352891608,0.200062671633567,
0.202986756515322,0.205937592228258,0.208915158703045,0.211919431063979,0.214950379584145,0.218007969641426,0.221092161675374,
0.224202911144970,0.227340168487287,0.230503879077082,0.233693983187330,0.236910415950735,0.240153107322212,0.243421982042395,
0.246716959602150,0.250037954208149,0.253384874749502,0.256757624765473,0.260156102414297,0.263580200443124,0.267029806159088,
0.270504801401546,0.274005062515491,0.277530460326145,0.281080860114772,0.284656121595719,0.288256098894684,0.291880640528266,
0.295529589384772,0.299202782706319,0.302900052072249,0.306621223383861,0.310366116850476,0.314134546976858,0.317926322551995,
0.321741246639265,0.325579116567984,0.329439723926370,0.333322854555913,0.337228288547187,0.341155800237088,0.345105158207542,
0.349076125285659,0.353068458545379,0.357081909310586,0.361116223159734,0.365171139931957,0.369246393734707,0.373341712952906,
0.377456820259630,0.381591432628327,0.385745261346578,0.389918012031413,0.394109384646178,0.398319073518970,0.402546767362628,
0.406792149296313,0.411054896868648,0.415334682082447,0.419631171421025,0.423944025876092,0.428272900977240,0.432617446823010,
0.436977308113566,0.441352124184942,0.445741529044892,0.450145151410333,0.454562614746372,0.458993537306924,0.463437532176919,
0.467894207316091,0.472363165604355,0.476844004888752,0.481336318031976,0.485839692962470,0.490353712726080,0.494877955539273,
0.499411994843909,0.503955399363551,0.508507733161323,0.513068555699288,0.517637421899355,0.522213882205698,0.526797482648677,
0.531387764910250,0.535984266390873,0.540586520277873,0.545194055615271,0.549806397375059,0.554423066529925,0.559043580127367,
0.563667451365255,0.568294189668758,0.572923300768657,0.577554286781036,0.582186646288295,0.586819874421518,0.591453462944145,
0.596086900336938,0.600719671884235,0.605351259761461,0.609981143123876,0.614608798196554,0.619233698365560,0.623855314270311,
0.628473113897097,0.633086562673743,0.637695123565393,0.642298257171384,0.646895421823197,0.651486073683463,0.656069666845984,
0.660645653436778,0.665213483716071,0.669772606181279,0.674322467670894,0.678862513469280,0.683392187412346,0.687910931994072,
0.692418188473860,0.696913396984669,0.701395996641941,0.705865425653245,0.710321121428659,0.714762520691805,0.719189059591572,
0.723600173814446,0.727995298697444,0.732373869341604,0.736735320726035,0.741079087822448,0.745404605710181,0.749711309691659,
0.753998635408275,0.758266018956642,0.762512897005214,0.766738706911209,0.770942886837823,0.775124875871706,0.779284114140656,
0.783420042931493,0.787532104808104,0.791619743729605,0.795682405168591,0.799719536229450,0.803730585766697,0.807715004503293,
0.811672245148929,0.815601762518238,0.819503013648877,0.823375457919485,0.827218557167454,0.831031775806479,0.834814580943888,
0.838566442497660,0.842286833313154,0.845975229279472,0.849631109445462,0.853253956135277,0.856843255063512,0.860398495449839,
0.863919170133128,0.867404775685036,0.870854812522979,0.874268785022513,0.877646201629052,0.880986574968908,0.884289421959606,
0.887554263919461,0.890780626676352,0.893968040675706,0.897116041087614,0.900224167913075,0.903291966089327,0.906318985594234,
0.909304781549699,0.912248914324069,0.915150949633503,0.918010458642267,0.920827018061942,0.923600210249485,0.926329623304155,
0.929014851163218,0.931655493696477,0.934251156799509,0.936801452485660,0.939305998976727,0.941764420792302,0.944176348837763,
0.946541420490890,0.948859279687036,0.951129577002897,0.953351969738797,0.955526121999484,0.957651704773415,0.959728396010494,
0.961755880698262,0.963733850936484,0.965662006010127,0.967540052460712,0.969367704156008,0.971144682358047,0.972870715789433,
0.974545540697955,0.976168900919431,0.977740547938816,0.979260240949521,0.980727746910935,0.982142840604148,0.983505304685805,
0.984814929740163,0.986071514329232,0.987274865041078,0.988424796536185,0.989521131591962,0.990563701145268,0.991552344333033,
0.992486908530931,0.993367249390062,0.994193230871689,0.994964725279978,0.995681613292727,0.996343783990116,0.996951134881430,
0.997503571929754,0.998001009574646,0.998443370752760,0.998830586916445,0.999162598050277,0.999439352685530,0.999660807912609,
0.999826929391403,0.999937691359569,0.999993076638758,0.999993076638758,0.999937691359569,0.999826929391403,0.999660807912609,
0.999439352685530,0.999162598050277,0.998830586916445,0.998443370752760,0.998001009574646,0.997503571929754,0.996951134881430,
0.996343783990116,0.995681613292727,0.994964725279978,0.994193230871689,0.993367249390062,0.992486908530931,0.991552344333033,
0.990563701145268,0.989521131591962,0.988424796536185,0.987274865041078,0.986071514329232,0.984814929740163,0.983505304685805,
0.982142840604148,0.980727746910935,0.979260240949521,0.977740547938816,0.976168900919431,0.974545540697955,0.972870715789433,
0.971144682358047,0.969367704156008,0.967540052460712,0.965662006010127,0.963733850936484,0.961755880698262,0.959728396010494,
0.957651704773415,0.955526121999484,0.953351969738797,0.951129577002897,0.948859279687036,0.946541420490890,0.944176348837763,
0.941764420792302,0.939305998976727,0.936801452485660,0.934251156799509,0.931655493696477,0.929014851163218,0.926329623304155,
0.923600210249485,0.920827018061942,0.918010458642267,0.915150949633503,0.912248914324069,0.909304781549699,0.906318985594234,
0.903291966089327,0.900224167913075,0.897116041087614,0.893968040675706,0.890780626676352,0.887554263919461,0.884289421959606,
0.880986574968908,0.877646201629052,0.874268785022513,0.870854812522979,0.867404775685036,0.863919170133128,0.860398495449839,
0.856843255063512,0.853253956135277,0.849631109445462,0.845975229279472,0.842286833313154,0.838566442497660,0.834814580943888,
0.831031775806479,0.827218557167454,0.823375457919485,0.819503013648877,0.815601762518238,0.811672245148929,0.807715004503293,
0.803730585766697,0.799719536229450,0.795682405168591,0.791619743729605,0.787532104808104,0.783420042931493,0.779284114140656,
0.775124875871706,0.770942886837823,0.766738706911209,0.762512897005214,0.758266018956642,0.753998635408275,0.749711309691659,
0.745404605710181,0.741079087822448,0.736735320726035,0.732373869341604,0.727995298697444,0.723600173814446,0.719189059591572,
0.714762520691805,0.710321121428659,0.705865425653245,0.701395996641941,0.696913396984669,0.692418188473860,0.687910931994072,
0.683392187412346,0.678862513469280,0.674322467670894,0.669772606181279,0.665213483716071,0.660645653436778,0.656069666845984,
0.651486073683463,0.646895421823197,0.642298257171384,0.637695123565393,0.633086562673743,0.628473113897097,0.623855314270311,
0.619233698365560,0.614608798196554,0.609981143123876,0.605351259761461,0.600719671884235,0.596086900336938,0.591453462944145,
0.586819874421518,0.582186646288295,0.577554286781036,0.572923300768657,0.568294189668758,0.563667451365255,0.559043580127367,
0.554423066529925,0.549806397375059,0.545194055615271,0.540586520277873,0.535984266390873,0.531387764910250,0.526797482648677,
0.522213882205698,0.517637421899355,0.513068555699288,0.508507733161323,0.503955399363551,0.499411994843909,0.494877955539273,
0.490353712726080,0.485839692962470,0.481336318031976,0.476844004888752,0.472363165604355,0.467894207316091,0.463437532176919,
0.458993537306924,0.454562614746372,0.450145151410333,0.445741529044892,0.441352124184942,0.436977308113566,0.432617446823010,
0.428272900977240,0.423944025876092,0.419631171421025,0.415334682082447,0.411054896868648,0.406792149296313,0.402546767362628,
0.398319073518970,0.394109384646178,0.389918012031413,0.385745261346578,0.381591432628327,0.377456820259630,0.373341712952906,
0.369246393734707,0.365171139931957,0.361116223159734,0.357081909310586,0.353068458545379,0.349076125285659,0.345105158207542,
0.341155800237088,0.337228288547187,0.333322854555913,0.329439723926370,0.325579116567984,0.321741246639265,0.317926322551995,
0.314134546976858,0.310366116850476,0.306621223383861,0.302900052072249,0.299202782706319,0.295529589384772,0.291880640528266,
0.288256098894684,0.284656121595719,0.281080860114772,0.277530460326145,0.274005062515491,0.270504801401546,0.267029806159088,
0.263580200443124,0.260156102414297,0.256757624765473,0.253384874749502,0.250037954208149,0.246716959602150,0.243421982042395,
0.240153107322212,0.236910415950735,0.233693983187330,0.230503879077082,0.227340168487287,0.224202911144970,0.221092161675374,
0.218007969641426,0.214950379584145,0.211919431063979,0.208915158703045,0.205937592228258,0.202986756515322,0.200062671633567,
0.197165352891608,0.194294810883808,0.191451051537521,0.188634076161092,0.185843881492603,0.183080459749330,0.180343798677895,
0.177633881605099,0.174950687489406,0.172294190973047,0.169664362434756,0.167061168043071,0.164484569810215,0.161934525646523,
0.159410989415382,0.156913910988681,0.154443236302739,0.151998907414690,0.149580862559307,0.147189036206239,0.144823359117643,
0.142483758406191,0.140170157593422,0.137882476668430,0.135620632146861,0.133384537130188,0.131174101365265,0.128989231304121,
0.126829830163977,0.124695797987470,0.122587031703061,0.120503425185606,0.118444869317065,0.116411252047342,0.114402458455224,
0.112418370809397,0.110458868629539,0.108523828747440,0.106613125368160,0.104726630131186,0.102864212171574,0.101025738181062,
0.0992110724691285,0.0974200770239845,0.0956526115734742,0.0939085336458712,0.0921876986305533,0.0904899598385314,0.0888151685628239,
0.0871631741386537,0.0855338240034521,0.0839269637566551,0.0823424372192725,0.0807800864932165,0.0792397520203719,0.0777212726413935,
0.0762244856542149,0.0747492268722524,0.0732953306822925,0.0718626301020442,0.0704509568373443,0.0690601413390015,0.0676900128592654,
0.0663403995079058,0.0650111283078902,0.0637020252506474,0.0624129153509019,0.0611436227010695,0.0598939705252005,0.0586637812324594,
0.0574528764701284,0.0562610771761265,0.0550882036310289,0.0539340755095800,0.0527985119316884,0.0516813315128928,0.0505823524142905,
0.0495013923919190,0.0484382688455806,0.0473927988671032,0.0463647992880254,0.0453540867267027,0.0443604776348212,0.0433837883433165,
0.0424238351076866,0.0414804341526948,0.0405534017164524,0.0396425540938801,0.0387477076795357,0.0378686790098079,0.0370052848044674,
0.0361573420075710,0.0353246678277150,0.0345070797776307,0.0337043957131211,0.0329164338713316,0.0321430129083531,0.0313839519361538,
0.0306390705588351,0.0299081889082109,0.0291911276787067,0.0284877081615754,0.0277977522784294,0.0271210826140864,0.0264575224487275,
0.0258068957893668,0.0251690274006307,0.0245437428348475,0.0239308684614461,0.0233302314956640,0.0227416600265644,0.0221649830443630,
0.0216000304670658,0.0210466331664170,0.0205046229931609,0.0199738328016159,0.0194540964735653,0.0189452489414643,0.0184471262109674,
0.0179595653827761,0.0174824046738122,0.0170154834377170,0.0165586421846812,0.0161117226006068,0.0156745675656065,0.0152470211718430,
0.0148289287407116,0.0144201368393710,0.0140204932966261,0.0136298472181675,0.0132480490011709,0.0128749503482636,0.0125104042808607,
0.0121542651518766,0.0118063886578186,0.0114666318502657,0.0111348531467398,0.0108109123409746,0.0104946706125871,0.0101859905361599,
0.00988473608973834,0.00959077266274925,0.00930396706334889,0.00902418752520525,0.00875130371372193,0.00848518673171074,0.00822570912451905,
0.00797274488462004,0.00772616945567175,0.00748585973605332,0.00725169408188482,0.00702355230953866,0.00680131569764976,0.00658486698863229,
0.00637409038971055,0.00616887157347153,0.00596909767794747,0.00577465730623569,0.00558544052566415,0.00540133886651029,0.00522224532028167,
0.00504805433756603,0.00487866182545930,0.00471396514457954,0.00455386310567510,0.00439825596583520,0.00424704542431135,0.00410013461795780,
0.00395742811629930,0.00381883191623476,0.00368425343638493,0.00355360151109250,0.00342678638408327,0.00330371970179628,0.00318431450639183,
0.00306848522844527,0.00295614767933534,0.00284721904333506,0.00274161786941374,0.00263926406275841,0.00254007887602278,0.00244398490031225,
0.00235090605591301,0.00226076758277353,0.00217349603074663,0.00208901924960018,0.00200726637880464,0.00192816783710533,0.00185165531188757,
0.00177766174834261,0.00170612133844214,0.00163696950972940,0.00157014291393452,0.00150557941542184,0.00144321807947699,0.00138299916044111,
0.00132486408969991,0.00126875546353501,0.00121461703084474,0.00116239368074205,0.00111203143003635,0.00106347741060687,0.00101667985667417,
0.000971588091977111,0.000928152516862039,0.000886324595291020,0.000846056841775827,0.000807302808244372,0.000770017070846069,0.000734155216702593,
0.000699673830610405,0.000666530481701268,0.000634683710066956,0.000604093013354175,0.000574718833335692,0.000546522542463513,0.000519466430409878,
0.000493513690601726,0.000468628406754190,0.000444775539408549,0.000421920912480016,0.000400031199820560,0.000379073911801912,0.000359017381923781,
0.000339830753452181,0.000321483966092682,0.000303947742703283,0.000287193576051495,0.000271193715620105,0.000255921154466007,0.000241349616136339,
0.000227453541646089,0.000214208076521206,0.000201589057911143,0.000189573001774655,0.000178137090142558,0.000167259158461053,0.000156917683019102,
0.000147091768463240,0.000137761135403096,0.000128906108110785,0.000120507602317226,0.000112547113108345,0.000105006702923987,9.78689896622899e-05,
9.11171348921403e-05,8.47348321762326e-05,7.87062955071623e-05,7.30162478588579e-05,6.76499098555720e-05,6.25929885605379e-05,5.78316663863055e-05,
5.33525901286603e-05,4.91428601259405e-05,4.51900195454606e-05,4.14820437986555e-05,3.80073300864637e-05,3.47546870763700e-05,3.17133247124374e-05,
2.88728441595609e-05,2.62232278830887e-05,2.37548298648596e-05,2.14583659566217e-05,1.93249043717067e-05,1.73458563157455e-05,1.55129667571281e-05,
1.38183053378257e-05,1.22542574251076e-05,1.08135153046081e-05,9.48906951511384e-06,8.27420032536606e-06,7.16246935309510e-06,6.14771132642611e-06,
5.22402598772236e-06,4.38577013985947e-06,3.62754983485135e-06,2.94421270467906e-06};
*/

#include "fft.h"
#include "stdlib.h"
#include "math.h"

// --- 宏定义 ---
// 幅度阈值：低于此幅度的局部峰值将被忽略，以滤除噪声。可根据实际信号调整。
#define AMPLITUDE_THRESHOLD 0.01f 
// 搜索起始索引：忽略直流分量和极低频噪声。
#define FFT_SEARCH_START_INDEX 16 
// 允许存储的最大峰值数量，以防找到过多峰值导致内存问题。
#define MAX_PEAKS_FOUND 50 

// --- 全局变量定义 (匹配 .h 文件) ---
float32_t FFT_Data[FFT_N << 1];
float32_t Mag[FFT_N];
float32_t Mag_Single[FFT_N >> 1];
float32_t Mag_max;
float32_t Mag_secmax;
float32_t Mag_thirmax;
float32_t Mag_max_index;    // <-- 类型从 u32 变为 float32_t
float32_t Mag_secmax_index; // <-- 类型从 u32 变为 float32_t
float32_t Mag_thirmax_index;// <-- 类型从 u32 变为 float32_t

// --- 内部辅助结构体和函数 ---

// 用于存储找到的峰值信息
typedef struct {
    float32_t amplitude;
    uint32_t index;
} PeakInfo;

// 比较函数，用于后续对峰值按幅度进行降序排序
static int compare_peaks(const void* a, const void* b) {
    PeakInfo* peakA = (PeakInfo*)a;
    PeakInfo* peakB = (PeakInfo*)b;
    if (peakB->amplitude > peakA->amplitude) {
        return 1;
    } else if (peakB->amplitude < peakA->amplitude) {
        return -1;
    }
    return 0;
}




/*********************************************************************************
* 函数名称: DSP_FFT
* 函数说明: 执行FFT，并使用高精度补偿算法找出前三个主要频率峰值及其精确频率和幅度。
* 此版本经过优化，采用单次遍历和局部峰值检测算法。
* 输入参数: 无 (使用全局ADC数据)
* 返回值  : 无 (结果存储在全局变量中)
*********************************************************************************/
void DSP_FFT(const uint16_t* p_adc_data)
{
    // =================================================================
    // 1. 数据预处理,DMA ping-ping处理
    // =================================================================
    for (uint16_t i = 0; i < FFT_N; i++) {
        FFT_Data[i << 1] = p_adc_data[i] * 3.30f / 4095.0f;
        FFT_Data[(i << 1) + 1] = 0;
    }

    float32_t dc_offset = 0;
    arm_mean_f32(&FFT_Data[0], FFT_N, &dc_offset);
    for (uint16_t i = 0; i < FFT_N; i++) {
        FFT_Data[i << 1] -= dc_offset;
    }

    // 假设使用矩形窗，以匹配补偿公式。如需加窗，补偿公式需同步更改。
    
    // =================================================================
    // 2. FFT 计算
    // =================================================================
    arm_cfft_radix4_instance_f32 fft_inst;
    arm_cfft_radix4_init_f32(&fft_inst, FFT_N, 0, 1);
    arm_cfft_radix4_f32(&fft_inst, FFT_Data);

    // =================================================================
    // 3. 计算单边幅度谱 (用于峰值搜索)
    // =================================================================
    arm_cmplx_mag_f32(FFT_Data, Mag, FFT_N);
    Mag_Single[0] = Mag[0] / FFT_N;
    for (uint16_t i = 1; i < (FFT_N >> 1); i++) {
        Mag_Single[i] = 2.0f * Mag[i] / FFT_N;
    }

    // =================================================================
    // 4. 峰值搜索、排序与高精度补偿
    // =================================================================
    
    PeakInfo found_peaks[MAX_PEAKS_FOUND];
    uint32_t peak_count = 0;

    // 步骤A: 查找所有高于阈值的局部峰值
    for (uint32_t i = FFT_SEARCH_START_INDEX; i < (FFT_N >> 1) - 1; i++) {
        if (Mag_Single[i] > Mag_Single[i - 1] && Mag_Single[i] > Mag_Single[i + 1] && Mag_Single[i] > AMPLITUDE_THRESHOLD) {
            if (peak_count < MAX_PEAKS_FOUND) {
                found_peaks[peak_count].amplitude = Mag_Single[i];
                found_peaks[peak_count].index = i;
                peak_count++;
            }
        }
    }
    
    // 初始化全局结果变量
    Mag_max = 0; Mag_max_index = 0.0f;
    Mag_secmax = 0; Mag_secmax_index = 0.0f;
    Mag_thirmax = 0; Mag_thirmax_index = 0.0f;

    if (peak_count > 0) {
        // 步骤B: 对找到的峰值按幅度进行排序
        if (peak_count > 1) {
            qsort(found_peaks, peak_count, sizeof(PeakInfo), compare_peaks);
        }

        // 步骤C: 对排序后的前3个峰值进行高精度补偿
        uint32_t num_to_process = (peak_count < 3) ? peak_count : 3;
        for (uint32_t i = 0; i < num_to_process; i++) {
            uint32_t k = found_peaks[i].index;

            // 安全检查，确保有足够的旁瓣进行计算
            if (k < 2 || k > (FFT_N >> 1) - 3) continue;

            // --- 中间变量计算 (z1, z2, ka, r) ---
            float32_t Xkm1_real = FFT_Data[2*(k-1)], Xkm1_imag = FFT_Data[2*(k-1)+1];
            float32_t Xk_real   = FFT_Data[2*k],     Xk_imag   = FFT_Data[2*k+1];
            float32_t Xkp1_real = FFT_Data[2*(k+1)], Xkp1_imag = FFT_Data[2*(k+1)+1];
            float32_t Xkp2_real = FFT_Data[2*(k+2)], Xkp2_imag = FFT_Data[2*(k+2)+1];

            float32_t Z1_real = Xk_real - (Xkm1_real + Xkp1_real) / 2.0f;
            float32_t Z1_imag = Xk_imag - (Xkm1_imag + Xkp1_imag) / 2.0f;

            float32_t Z2_real = Xkp1_real - (Xk_real + Xkp2_real) / 2.0f;
            float32_t Z2_imag = Xkp1_imag - (Xk_imag + Xkp2_imag) / 2.0f;

            float32_t Z1_mag, Z2_mag;
            arm_sqrt_f32(Z1_real*Z1_real + Z1_imag*Z1_imag, &Z1_mag);
            arm_sqrt_f32(Z2_real*Z2_real + Z2_imag*Z2_imag, &Z2_mag);
            
            float32_t ka = (Z2_mag > 1e-6f) ? (Z1_mag / Z2_mag) : 0;
            float32_t r = (2.0f - ka) / (1.0f + ka);

            // --- 精确频率计算 ---
            float32_t precise_freq = (k + r) * Fs * 1000.0f / FFT_N;

            // --- 精确幅度计算 (采用用户图片指定的新公式) ---
            float32_t precise_amp;
            
            // 安全处理：当r非常接近0时，分母sin(r*pi)也接近0，直接计算会导致数值不稳定。
            // 此时补偿意义不大，直接使用未补偿的幅度值更稳健。
            if (fabsf(r) < 1e-5f) {
                precise_amp = found_peaks[i].amplitude;
            } else {
                // 【新公式】 ao = 2*pi*r*(1-r*r)*(abs(z1))/(N*sin(r*pi))
                float32_t sin_r_pi = arm_sin_f32(PI * r);
                
                // 再次检查分母，防止除零
                if (fabsf(sin_r_pi) < 1e-6f) {
                    precise_amp = found_peaks[i].amplitude;
                } else {
                    precise_amp = (2.0f * PI * r * (1.0f - r*r) * Z1_mag) / (FFT_N * sin_r_pi);
                }
            }
            
            // 将精确计算结果存入对应的全局变量
            if (i == 0) {
                Mag_max = precise_amp;
                Mag_max_index = precise_freq;
            } else if (i == 1) {
                Mag_secmax = precise_amp;
                Mag_secmax_index = precise_freq;
            } else if (i == 2) {
                Mag_thirmax = precise_amp;
                Mag_thirmax_index = precise_freq;
            }
        }
    }
}